import sys
import os
sys.path.append(os.path.abspath('.'))

from server.database.supabase_client import supabase
from datetime import datetime

class DatabaseMigration:
    """
    Sistema de migraci√≥n para crear y mantener la estructura de la base de datos
    """
    
    def __init__(self):
        self.table_name = "students"
        
    def get_complete_student_schema(self):
        """
        Define el esquema completo de la tabla students con TODAS las columnas necesarias
        """
        return {
            # ‚úÖ CAMPOS PRINCIPALES DEL ESTUDIANTE
            'curricular_units_1st_sem_grade': 15.0,      # REAL
            'curricular_units_2nd_sem_grade': 14.5,      # REAL  
            'curricular_units_1st_sem_approved': 5,      # INTEGER
            'curricular_units_2nd_sem_approved': 4,      # INTEGER
            'curricular_units_1st_sem_evaluations': 6,   # INTEGER
            'curricular_units_2nd_sem_evaluations': 5,   # INTEGER
            'unemployment_rate': 10.0,                   # REAL
            'gdp': 1.5,                                  # REAL
            'age_at_enrollment': 20,                     # INTEGER
            
            # ‚úÖ CAMPOS CATEG√ìRICOS
            'scholarship_holder': 'Yes',                 # TEXT
            'tuition_fees_up_to_date': 'Yes',           # TEXT
            'marital_status': 'Single',                 # TEXT
            'previous_qualification': 'Secondary education',  # TEXT
            'mothers_qualification': 'Higher education‚Äîbachelor\'s degree',  # TEXT
            'fathers_qualification': 'Secondary education‚Äî12th year of schooling or equivalent',  # TEXT
            
            # ‚úÖ RESULTADO REAL (TARGET)
            'target': 'Graduate',                       # TEXT
            
            # ‚úÖ PROBABILIDADES DEL MODELO ML (NUEVAS COLUMNAS)
            'probability_graduate': 0.75,              # REAL
            'probability_dropout': 0.15,               # REAL
            'probability_enrolled': 0.10,              # REAL
            
            # ‚úÖ METADATA DE LA PREDICCI√ìN
            'predicted_outcome': 'Graduate',           # TEXT - Clase predicha por el modelo
            'confidence': 0.75,                        # REAL - Confianza (probabilidad m√°xima)
            
            # ‚úÖ CAMPOS AUTOM√ÅTICOS (Supabase los maneja)
            # 'id': AUTO_INCREMENT PRIMARY KEY
            # 'created_at': TIMESTAMP DEFAULT NOW()
            # 'updated_at': TIMESTAMP DEFAULT NOW()
        }
    
    def create_table_with_schema(self):
        """
        Crea la tabla con el esquema completo insertando un registro que define todas las columnas
        """
        print("üèóÔ∏è Creando tabla students con esquema completo...")
        
        # Obtener datos de ejemplo con todas las columnas
        complete_schema = self.get_complete_student_schema()
        
        try:
            print("üìã Esquema definido:")
            print("   Campos num√©ricos:", len([k for k, v in complete_schema.items() if isinstance(v, (int, float))]))
            print("   Campos de texto:", len([k for k, v in complete_schema.items() if isinstance(v, str)]))
            print("   Total columnas:", len(complete_schema))
            
            # Insertar registro que crea todas las columnas
            print("\nüî® Insertando registro de esquema...")
            response = supabase.table(self.table_name).insert(complete_schema).execute()
            
            if response.data:
                schema_record_id = response.data[0]['id']
                print(f"‚úÖ Tabla creada con ID de esquema: {schema_record_id}")
                
                # Verificar que todas las columnas existen
                verify_response = supabase.table(self.table_name).select("*").limit(1).execute()
                if verify_response.data:
                    actual_columns = list(verify_response.data[0].keys())
                    print(f"‚úÖ Columnas creadas exitosamente: {len(actual_columns)}")
                    
                    # Verificar columnas cr√≠ticas
                    critical_columns = ['probability_graduate', 'probability_dropout', 'probability_enrolled', 'predicted_outcome', 'confidence']
                    missing_critical = [col for col in critical_columns if col not in actual_columns]
                    
                    if missing_critical:
                        print(f"‚ö†Ô∏è Columnas cr√≠ticas faltantes: {missing_critical}")
                    else:
                        print("‚úÖ Todas las columnas cr√≠ticas presentes")
                
                return schema_record_id
            else:
                print("‚ùå Error: No se pudo crear el registro de esquema")
                return None
                
        except Exception as e:
            print(f"‚ùå Error creando tabla: {e}")
            return None
    
    def verify_schema(self):
        """
        Verifica que la tabla tiene todas las columnas necesarias
        """
        print("üîç Verificando esquema de la tabla...")
        
        try:
            response = supabase.table(self.table_name).select("*").limit(1).execute()
            
            if response.data and len(response.data) > 0:
                actual_columns = list(response.data[0].keys())
                expected_columns = list(self.get_complete_student_schema().keys())
                
                print(f"üìä Columnas actuales: {len(actual_columns)}")
                print(f"üìä Columnas esperadas: {len(expected_columns)}")
                
                missing_columns = [col for col in expected_columns if col not in actual_columns]
                extra_columns = [col for col in actual_columns if col not in expected_columns and col not in ['id', 'created_at', 'updated_at']]
                
                if missing_columns:
                    print(f"‚ùå Columnas faltantes: {missing_columns}")
                    return False
                
                if extra_columns:
                    print(f"‚ÑπÔ∏è Columnas adicionales: {extra_columns}")
                
                print("‚úÖ Esquema verificado correctamente")
                return True
            else:
                print("‚ö†Ô∏è Tabla vac√≠a, no se puede verificar esquema")
                return False
                
        except Exception as e:
            print(f"‚ùå Error verificando esquema: {e}")
            return False
    
    def populate_sample_data(self):
        """
        Prueba la tabla con datos de ejemplo para testing
        """
        print("üìä Poblando tabla con datos de ejemplo...")
        
        sample_students = [
            # Estudiante exitoso
            {
                'curricular_units_1st_sem_grade': 18.0,
                'curricular_units_2nd_sem_grade': 17.5,
                'curricular_units_1st_sem_approved': 6,
                'curricular_units_2nd_sem_approved': 6,
                'curricular_units_1st_sem_evaluations': 6,
                'curricular_units_2nd_sem_evaluations': 6,
                'unemployment_rate': 8.0,
                'gdp': 2.0,
                'age_at_enrollment': 19,
                'scholarship_holder': 'Yes',
                'tuition_fees_up_to_date': 'Yes',
                'marital_status': 'Single',
                'previous_qualification': 'Secondary education',
                'mothers_qualification': 'Higher education‚Äîbachelor\'s degree',
                'fathers_qualification': 'Higher education‚Äîdegree',
                'target': 'Graduate',
                'probability_graduate': 0.85,
                'probability_dropout': 0.10,
                'probability_enrolled': 0.05,
                'predicted_outcome': 'Graduate',
                'confidence': 0.85
            },
            # Estudiante en riesgo
            {
                'curricular_units_1st_sem_grade': 9.0,
                'curricular_units_2nd_sem_grade': 8.5,
                'curricular_units_1st_sem_approved': 2,
                'curricular_units_2nd_sem_approved': 1,
                'curricular_units_1st_sem_evaluations': 8,
                'curricular_units_2nd_sem_evaluations': 9,
                'unemployment_rate': 15.0,
                'gdp': -1.0,
                'age_at_enrollment': 35,
                'scholarship_holder': 'No',
                'tuition_fees_up_to_date': 'No',
                'marital_status': 'Divorced',
                'previous_qualification': 'Basic education 3rd cycle (9th/10th/11th year) or equivalent',
                'mothers_qualification': 'Cannot read or write',
                'fathers_qualification': 'Unknown',
                'target': 'Dropout',
                'probability_graduate': 0.15,
                'probability_dropout': 0.70,
                'probability_enrolled': 0.15,
                'predicted_outcome': 'Dropout',
                'confidence': 0.70
            }
        ]
        
        try:
            for i, student in enumerate(sample_students, 1):
                response = supabase.table(self.table_name).insert(student).execute()
                if response.data:
                    print(f"‚úÖ Estudiante de ejemplo {i} insertado: ID {response.data[0]['id']}")
                else:
                    print(f"‚ùå Error insertando estudiante {i}")
            
            print(f"‚úÖ {len(sample_students)} estudiantes de ejemplo agregados")
            return True
            
        except Exception as e:
            print(f"‚ùå Error poblando datos: {e}")
            return False
    
    def run_full_migration(self, include_sample_data=True):
        """
        Ejecuta la migraci√≥n completa
        """
        print("üöÄ INICIANDO MIGRACI√ìN COMPLETA DE BASE DE DATOS")
        print("=" * 60)
        
        # Paso 1: Crear tabla con esquema completo
        schema_id = self.create_table_with_schema()
        if not schema_id:
            print("‚ùå Fall√≥ la creaci√≥n del esquema")
            return False
        
        # Paso 2: Verificar esquema
        if not self.verify_schema():
            print("‚ùå Fall√≥ la verificaci√≥n del esquema")
            return False
        
        # Paso 3: Poblar con datos de ejemplo (opcional)
        if include_sample_data:
            if not self.populate_sample_data():
                print("‚ö†Ô∏è Fall√≥ la inserci√≥n de datos de ejemplo (no cr√≠tico)")
        
        print("\n" + "=" * 60)
        print("‚úÖ MIGRACI√ìN COMPLETADA EXITOSAMENTE")
        print("=" * 60)
        print("üéØ La tabla students est√° lista para usar")
        print("üîó Puedes probar el API ahora: http://localhost:8000/predict")
        print("üìã Ver datos: http://localhost:8000/students")
        
        return True

def main():
    """
    Funci√≥n principal para ejecutar la migraci√≥n
    """
    print("üîß SISTEMA DE MIGRACI√ìN DE BASE DE DATOS")
    print("üìÖ", datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
    print("-" * 40)
    
    migration = DatabaseMigration()
    
    # Preguntar si incluir datos de ejemplo
    include_samples = input("¬øIncluir datos de ejemplo? (s/n): ").lower() in ['s', 'si', 'y', 'yes']
    
    success = migration.run_full_migration(include_sample_data=include_samples)
    
    if success:
        print("\nüéâ ¬°Base de datos lista para usar!")
    else:
        print("\nüí• Error en la migraci√≥n")

if __name__ == "__main__":
    main()